pkgname="zstd"
pkgver="1.5.7"
pkgrel=1

INSTALL_ROOT="sysroot"

# Tarball do tag do GitHub (estável e fácil de consumir)
sources=(
  "https://github.com/facebook/zstd/archive/refs/tags/v${pkgver}.tar.gz::zstd-${pkgver}.tar.gz"
)

sha256sums=(
  "37d7284556b20954e56e1ca85b80226768902e2edabd3b649e9e72c0c9012ee3 zstd-1.5.7.tar.gz"
)

pre_build() {
  : "${TARGET:=x86_64-linux-musl}"
  : "${TOOLS:=/mnt/adm/rootfs/tools}"
  : "${SYSROOT:=/mnt/adm/rootfs}"
  : "${JOBS:=4}"

  export PATH="$TOOLS/bin:$PATH"

  export CC="$TOOLS/bin/${TARGET}-gcc"
  export AR="$TOOLS/bin/${TARGET}-ar"
  export RANLIB="$TOOLS/bin/${TARGET}-ranlib"
  export STRIP="$TOOLS/bin/${TARGET}-strip"

  export CFLAGS="${CFLAGS:- -O2 -pipe}"
  export LDFLAGS="${LDFLAGS:-}"
}

build() {
  # build “make” padrão do projeto
  make -j"$JOBS" \
    CC="$CC" AR="$AR" RANLIB="$RANLIB" STRIP="$STRIP" \
    CFLAGS="$CFLAGS" LDFLAGS="$LDFLAGS" \
    PREFIX=/usr
}

install() {
  # instala no staging (DESTDIR) -> cross-toolchain.sh faz rsync para $ROOTFS
  make \
    DESTDIR="$DESTDIR" PREFIX=/usr \
    install

  # Opcional: enxugar docs
  rm -rf "$DESTDIR/usr/share/man" "$DESTDIR/usr/share/doc" 2>/dev/null || true
}
