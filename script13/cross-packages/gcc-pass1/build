pkgname="gcc-pass1"
pkgver="15.2.0"
pkgrel=1

INSTALL_ROOT="tools"

sources=(
  "https://gcc.gnu.org/pub/gcc/releases/gcc-${pkgver}/gcc-${pkgver}.tar.xz::gcc-${pkgver}.tar.xz"
)

sha256sums=(
  "438fd996826b0c82485a29da03a72d71d6e3541a83ec702df4271f6fe025d24e gcc-15.2.0.tar.xz"
)

pre_build() {
  : "${TARGET:=x86_64-linux-musl}"
  : "${TOOLS:=/mnt/adm/rootfs/tools}"
  : "${SYSROOT:=/mnt/adm/rootfs}"
  : "${JOBS:=4}"

  export PATH="$TOOLS/bin:$PATH"
  export CFLAGS="${CFLAGS:- -O2 -pipe}"
  export CXXFLAGS="${CXXFLAGS:- -O2 -pipe}"
}

build() {
  # Baixa GMP/MPFR/MPC/ISL dentro do source do GCC (evita múltiplos tarballs no extractor)
  ./contrib/download_prerequisites

  rm -rf _build
  mkdir -p _build
  cd _build

  # IMPORTANTE:
  # prefix=/ para que o staging tenha bin/, lib/, libexec/ na raiz do DESTDIR,
  # e o cross-toolchain.sh consiga rsync -> $TOOLS corretamente.
  ../configure \
    --prefix=/ \
    --libdir=/lib \
    --libexecdir=/libexec \
    --includedir=/include \
    --target="$TARGET" \
    --with-sysroot="$SYSROOT" \
    --with-newlib \
    --without-headers \
    --enable-languages=c \
    --disable-shared \
    --disable-threads \
    --disable-multilib \
    --disable-nls \
    --disable-bootstrap \
    --disable-libatomic \
    --disable-libgomp \
    --disable-libquadmath \
    --disable-libssp \
    --disable-libstdcxx \
    --disable-libvtv \
    --disable-werror

  make -j"$JOBS" all-gcc all-target-libgcc
}

install() {
  cd _build
  make DESTDIR="$DESTDIR" install-gcc install-target-libgcc

  # Mantém enxuto
  rm -rf "$DESTDIR/share" 2>/dev/null || true
}
