pkgname="binutils-final"
pkgver="2.45.1"
pkgrel=1

# binutils-final deve ir para o sysroot (ROOTFS) em /usr
INSTALL_ROOT="sysroot"

sources=(
  "https://ftp.gnu.org/gnu/binutils/binutils-${pkgver}.tar.xz::binutils-${pkgver}.tar.xz"
)

sha256sums=(
  "5fe101e6fe9d18fdec95962d81ed670fdee5f37e3f48f0bef87bddf862513aa5 binutils-2.45.1.tar.xz"
)

pre_build() {
  : "${TARGET:=x86_64-linux-musl}"
  : "${TOOLS:=/mnt/adm/rootfs/tools}"
  : "${SYSROOT:=/mnt/adm/rootfs}"
  : "${JOBS:=4}"

  # Para garantir que tools/pass1 estejam disponíveis durante o build
  export PATH="$TOOLS/bin:$PATH"
}

build() {
  rm -rf _build
  mkdir -p _build
  cd _build

  # binutils final:
  # - instala em /usr no sysroot
  # - sysroot do target final é /
  # - desativa NLS para reduzir deps
  # - desativa werror para evitar falhas por warnings
  ../configure \
    --prefix=/usr \
    --libdir=/usr/lib \
    --sysconfdir=/etc \
    --localstatedir=/var \
    --target="$TARGET" \
    --with-sysroot=/ \
    --disable-nls \
    --disable-werror

  make -j"$JOBS"
}

install() {
  cd _build
  make DESTDIR="$DESTDIR" install

  # Enxuto (opcional)
  rm -rf "$DESTDIR/usr/share/info" "$DESTDIR/usr/share/man" 2>/dev/null || true
}
