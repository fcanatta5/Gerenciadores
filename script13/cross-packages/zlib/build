pkgname="zlib"
pkgver="1.3.1"
pkgrel=1

INSTALL_ROOT="sysroot"

sources=(
  "https://zlib.net/zlib-${pkgver}.tar.gz::zlib-${pkgver}.tar.gz"
)

sha256sums=(
  "9a93b2b7dfdac77ceba5a558a580e74667dd6fede4585b91eefb60f03b72df23 zlib-1.3.1.tar.gz"
)

pre_build() {
  : "${TARGET:=x86_64-linux-musl}"
  : "${TOOLS:=/mnt/adm/rootfs/tools}"
  : "${SYSROOT:=/mnt/adm/rootfs}"
  : "${JOBS:=4}"

  export PATH="$TOOLS/bin:$PATH"
  export CC="$TOOLS/bin/${TARGET}-gcc"
  export AR="$TOOLS/bin/${TARGET}-ar"
  export RANLIB="$TOOLS/bin/${TARGET}-ranlib"
  export STRIP="$TOOLS/bin/${TARGET}-strip"

  export CFLAGS="${CFLAGS:- -O2 -pipe}"
}

build() {
  # zlib não usa autoconf configure padrão; é um ./configure próprio
  ./configure --prefix=/usr
  make -j"$JOBS"
}

install() {
  make DESTDIR="$DESTDIR" install

  # zlib geralmente instala lib em /usr/lib; ok para esta fase
  rm -rf "$DESTDIR/usr/share/man" 2>/dev/null || true
}
