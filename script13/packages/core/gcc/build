pkgname="gcc"
pkgver="15.2.0"
pkgrel=1

# GCC “completo” precisa das libs matemáticas (GMP/MPFR/MPC) e ISL.
# zlib é usado para recursos relacionados a debug/compactação e é bem comum manter.
depends=(binutils gmp mpfr mpc isl zlib)

sources=(
  "https://gcc.gnu.org/pub/gcc/releases/gcc-${pkgver}/gcc-${pkgver}.tar.xz::gcc-${pkgver}.tar.xz"
)

sha256sums=(
  "438fd996826b0c82485a29da03a72d71d6e3541a83ec702df4271f6fe025d24e gcc-15.2.0.tar.xz"
)

pre_build() {
  : "${JOBS:=$(nproc 2>/dev/null || echo 4)}"
}

build() {
  rm -rf _build
  mkdir -p _build
  cd _build

  # Para musl, é comum desabilitar libsanitizer (frequentemente problemático fora de glibc)
  # e evitar multilib.
  #
  # --with-sysroot=/ e --with-native-system-header-dir=/usr/include assumem
  # que seu sistema alvo já está “nativo” (não é pass1).
  ../configure \
    --prefix=/usr \
    --libdir=/usr/lib \
    --libexecdir=/usr/libexec \
    --sysconfdir=/etc \
    --localstatedir=/var \
    --enable-languages=c,c++ \
    --disable-multilib \
    --disable-nls \
    --disable-bootstrap \
    --disable-werror \
    --disable-libsanitizer \
    --with-system-zlib \
    --with-gmp=/usr \
    --with-mpfr=/usr \
    --with-mpc=/usr \
    --with-isl=/usr \
    --with-sysroot=/ \
    --with-native-system-header-dir=/usr/include

  make -j"$JOBS"
}

install() {
  cd _build
  make DESTDIR="$DESTDIR" install

  # Conveniência/compatibilidade: muitos builds esperam "cc"
  mkdir -p "$DESTDIR/usr/bin"
  ln -sf gcc "$DESTDIR/usr/bin/cc"

  # Opcional: enxugar docs para manter o sistema mais limpo
  rm -rf "$DESTDIR/usr/share/info" "$DESTDIR/usr/share/man" 2>/dev/null || true
}
