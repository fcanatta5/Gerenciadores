pkgname="musl"
pkgver="1.2.5"
pkgrel=1
category="core"
pkgdesc="musl libc - lightweight C standard library implementation"
url="https://musl.libc.org/"
license="MIT"
arch="x86_64"

depends=()

sources=(
  # Fonte oficial (musl releases). O Dockerfile abaixo referencia esse mesmo endpoint.
  "https://musl.libc.org/releases/musl-${pkgver}.tar.gz::musl-${pkgver}.tar.gz"
)

sha256sums=(
  # SHA256 do musl_1.2.5.orig.tar.gz (equivalente ao tarball upstream)
  "a9a118bbe84d8764da0ea0d28b3ab3fae8477fc7e4085d90102b8596fc7c75e4 musl-1.2.5.tar.gz"
)

pre_build() {
  : "${CC:=cc}"
  : "${CFLAGS:=-O2 -pipe}"
  : "${LDFLAGS:=}"
}

build() {
  # build in-tree (musl é simples), mas garantindo limpeza
  make distclean >/dev/null 2>&1 || true

  # Para x86_64-linux-musl nativo, isso é o suficiente.
  # --syslibdir=/lib garante o layout tradicional do loader/so em /lib
  ./configure \
    --prefix=/usr \
    --syslibdir=/lib

  make -j"$(getconf _NPROCESSORS_ONLN 2>/dev/null || echo 4)"
}

install() {
  # musl respeita DESTDIR no install
  make DESTDIR="$DESTDIR" install

  # Garantias úteis (sem complicar):
  # alguns sistemas esperam /usr/lib/libc.so (linker script) e/ou symlinks coerentes.
  # musl normalmente já instala corretamente; deixo apenas um “no-op” seguro.
  :
}
