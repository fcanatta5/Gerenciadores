#!/bin/sh
set -eu

DESTDIR=${1:?uso: build DESTDIR}

# Instalação final no sistema:
: "${PREFIX:=/usr}"
: "${SRCROOT:=$(pwd)}"
: "${BUILD_DIR:=$SRCROOT/.build}"

# Evita depender de texinfo/makeinfo para info pages
export MAKEINFO=true

# Se você padroniza flags globais no ambiente, elas são respeitadas.
# Caso não, isto deixa previsível em musl:
: "${CFLAGS:=-O2}"
: "${CXXFLAGS:=-O2}"
: "${LDFLAGS:=}"

mkdir -p "$BUILD_DIR"
cd "$BUILD_DIR"

# Binutils “host final” para x86_64-linux-musl:
# - --disable-multilib: sem multilib (sua política)
# - --disable-nls: reduz dependências (gettext)
# - --disable-werror: evita falhas por warnings com toolchains novas
# - --enable-plugins: útil para LTO/integrações
# - --enable-deterministic-archives: reprodutibilidade
# - --with-sysroot=/: comportamento típico em sistema final
# - --libdir=/usr/lib: garante layout esperado em x86_64 sem multilib
"$SRCROOT/configure" \
  --build=x86_64-linux-musl \
  --host=x86_64-linux-musl \
  --prefix="$PREFIX" \
  --sysconfdir=/etc \
  --localstatedir=/var \
  --libdir=/usr/lib \
  --disable-nls \
  --disable-werror \
  --disable-multilib \
  --enable-plugins \
  --enable-shared \
  --enable-deterministic-archives \
  --with-sysroot=/ \
  CFLAGS="$CFLAGS" \
  CXXFLAGS="$CXXFLAGS" \
  LDFLAGS="$LDFLAGS"

make ${MAKEFLAGS:-}

make DESTDIR="$DESTDIR" install

# Reforço: não instalar info pages
rm -rf "$DESTDIR$PREFIX/share/info" 2>/dev/null || true
