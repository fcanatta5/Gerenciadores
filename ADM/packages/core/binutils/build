#!/bin/sh
set -eu

DESTDIR=${1:?uso: build DESTDIR}

# Instalação final no sistema: /usr
: "${PREFIX:=/usr}"
: "${SRCROOT:=$(pwd)}"
: "${BUILD_DIR:=$SRCROOT/.build}"

mkdir -p "$BUILD_DIR"
cd "$BUILD_DIR"

# Evita exigir texinfo/makeinfo para gerar documentação info:
# (na prática, "MAKEINFO=true" faz o build prosseguir sem criar info pages)
export MAKEINFO=true

# Opções alinhadas com um binutils "host" padrão para sistema final.
# - --disable-nls: reduz dependências (gettext)
# - --disable-werror: evita falhas por warnings com toolchains novas
# - --enable-plugins: útil para LTO/integrações
# - --enable-deterministic-archives: reprodutibilidade
# - --disable-multilib: mantém simples (ajuste se seu sistema for multilib)
"$SRCROOT/configure" \
  --prefix="$PREFIX" \
  --sysconfdir=/etc \
  --localstatedir=/var \
  --disable-nls \
  --disable-werror \
  --enable-plugins \
  --enable-shared \
  --enable-deterministic-archives \
  --with-sysroot=/ \
  --disable-multilib

make ${MAKEFLAGS:-}

make DESTDIR="$DESTDIR" install

# Opcional: se você não quer instalar info em hipótese alguma, garanta remoção.
# (Em geral, com MAKEINFO=true elas não são geradas, mas isto reforça.)
rm -rf "$DESTDIR$PREFIX/share/info" 2>/dev/null || true
