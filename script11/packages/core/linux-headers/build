#!/usr/bin/env bash
# core/linux-headers/build
# Linux API Headers (UAPI) para o sysroot/rootfs.
# Instala em: DESTDIR/usr/include

set -Eeuo pipefail

PKG_NAME="linux-headers"
PKG_CAT="core"
PKG_VER="6.18.1"
PKG_DESC="Linux kernel UAPI headers for userspace (musl/gcc toolchain + system build)."
PKG_URL="https://www.kernel.org/"
PKG_LICENSE="GPL-2.0-only"

# Normalmente headers não exigem deps runtime; mas na prática você quer garantir ordem no sistema base.
PKG_DEPS=()
PKG_BDEPS=()

# Fonte oficial do kernel (tar.xz).
SOURCES=(
  "https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${PKG_VER}.tar.xz"
)

# IMPORTANTE:
# - Seu adm.sh exige checksum para fontes não-git, a menos que ALLOW_NO_CHECKSUM=1.
# - Como esta plataforma não me permite calcular o sha256 real do tarball aqui,
#   deixo ALLOW_NO_CHECKSUM=1 por padrão para você prosseguir AGORA.
# - Assim que possível, substitua por SHA256SUMS=( "<sha256-real>" ) e coloque ALLOW_NO_CHECKSUM=0.
ALLOW_NO_CHECKSUM=1
SHA256SUMS=(
  # "<sha256-real-do-linux-${PKG_VER}.tar.xz>"
)

do_configure(){
  : # nada a configurar
}

do_build(){
  : # headers são instalados via "make headers_install"
}

do_install(){
  # Opcional, mas recomendado: usar os helpers para logs/execução consistente.
  # Ajuste o caminho se você instalou a lib em outro local.
  if [[ -r "/var/lib/adm/lib/adm-build-helpers.sh" ]]; then
    # shellcheck disable=SC1091
    source "/var/lib/adm/lib/adm-build-helpers.sh"
    adm_src_enter
  else
    cd "${SRCTOP}"
  fi

  # Limpa estado para evitar lixo de build anterior no tree do kernel
  make mrproper

  # Instala apenas UAPI headers no DESTDIR
  # (equivalente ao fluxo recomendado por LFS/Kernel docs)
  make headers
  make INSTALL_HDR_PATH="${DESTDIR}/usr" headers_install

  # Limpeza pós-install (evita arquivos de build/controle desnecessários em /usr/include)
  # .install e comandos auxiliares podem aparecer dependendo da versão do kernel
  find "${DESTDIR}/usr/include" -type f \
    \( -name '.install' -o -name '.install.cmd' -o -name '..install.cmd' -o -name '.*.cmd' \) \
    -delete 2>/dev/null || true

  # Alguns kernels instalam arquivos vazios/placeholder; não é fatal, mas reduz ruído.
  find "${DESTDIR}/usr/include" -type f -size 0 -delete 2>/dev/null || true
}
