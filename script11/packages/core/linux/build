#!/usr/bin/env bash
# /var/lib/adm/packages/core/linux/build
# Linux kernel (x86_64) - build e instalação em DESTDIR (/boot + /lib/modules).
#
# Corrigido: NÃO depende de função externa "die".
#
# Config do kernel (primeiro que existir):
#   1) $LINUX_CONFIG (env)
#   2) /var/lib/adm/packages/<PKGID>/files/boot/config-${PKG_VER}
#   3) /var/lib/adm/packages/<PKGID>/files/boot/config
#   4) /var/lib/adm/packages/<PKGID>/files/etc/kernel/config-${PKG_VER}
#   5) /var/lib/adm/packages/<PKGID>/files/etc/kernel/config
#
# Requisitos práticos de build (normalmente):
# - core/make, core/flex, core/bison, extra/bc, core/perl
# Este script tenta reduzir dependências comuns desabilitando BTF e assinatura de módulos.

set -Eeuo pipefail

PKG_NAME="linux"
PKG_CAT="core"
PKG_VER="6.18.1"
PKG_DESC="Linux kernel (x86_64) + modules"
PKG_URL="https://www.kernel.org/"
PKG_LICENSE="GPL-2.0-only"

PKG_DEPS=( "core/musl" )
PKG_BDEPS=(
  "core/make"
  "core/flex"
  "core/bison"
  "extra/bc"
  # "core/perl"     # recomendado (scripts)
  # "core/openssl"  # somente se habilitar assinatura de módulos
)

SOURCES=(
  "https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${PKG_VER}.tar.xz"
)

ALLOW_NO_CHECKSUM=1
SHA256SUMS=(
  # "<sha256-real-do-linux-${PKG_VER}.tar.xz>"
)

: "${JOBS:=4}"

pkgdir(){
  local root="${ADM_ROOT:-/var/lib/adm}"
  echo "${root}/packages/${PKGID}"
}

pick_kernel_config(){
  local d; d="$(pkgdir)"
  if [[ -n "${LINUX_CONFIG:-}" && -f "${LINUX_CONFIG}" ]]; then
    echo "${LINUX_CONFIG}"
    return 0
  fi
  local c
  for c in \
    "${d}/files/boot/config-${PKG_VER}" \
    "${d}/files/boot/config" \
    "${d}/files/etc/kernel/config-${PKG_VER}" \
    "${d}/files/etc/kernel/config"
  do
    if [[ -f "$c" ]]; then
      echo "$c"
      return 0
    fi
  done
  return 1
}

do_configure(){
  # Kernel é in-tree; usamos BUILD_DIR como O=... (out-of-tree) para não sujar SRCTOP.
  if [[ -r "/var/lib/adm/lib/adm-build-helpers.sh" ]]; then
    # shellcheck disable=SC1091
    source "/var/lib/adm/lib/adm-build-helpers.sh"
    adm_src_enter
    adm_clean_builddir
  else
    export BUILD_DIR="${WORKDIR}/build"
    rm -rf "${BUILD_DIR}"
    mkdir -p "${BUILD_DIR}"
  fi

  cd "${SRCTOP}"
  make mrproper

  local cfg=""
  if cfg="$(pick_kernel_config 2>/dev/null)"; then
    echo "INFO: usando config: ${cfg}"
    install -m 0644 "${cfg}" "${BUILD_DIR}/.config"
  else
    echo "WARN: nenhum config fornecido. Usando defconfig (x86_64)."
    make O="${BUILD_DIR}" defconfig
  fi

  # Evita dependências extras comuns em base mínima:
  # - BTF (pahole)
  # - assinatura de módulos (openssl + chaves)
  if [[ -x "${SRCTOP}/scripts/config" ]]; then
    "${SRCTOP}/scripts/config" --file "${BUILD_DIR}/.config" \
      -d DEBUG_INFO_BTF \
      -d MODULE_SIG \
      -d SYSTEM_TRUSTED_KEYS \
      -d SYSTEM_REVOCATION_KEYS || true
  else
    # fallback best-effort
    sed -i \
      -e 's/^CONFIG_DEBUG_INFO_BTF=y/# CONFIG_DEBUG_INFO_BTF is not set/' \
      -e 's/^CONFIG_MODULE_SIG=y/# CONFIG_MODULE_SIG is not set/' \
      "${BUILD_DIR}/.config" || true
  fi

  make O="${BUILD_DIR}" olddefconfig
}

do_build(){
  cd "${SRCTOP}"
  make O="${BUILD_DIR}" ${MAKEFLAGS:-"-j${JOBS}"} bzImage
  make O="${BUILD_DIR}" ${MAKEFLAGS:-"-j${JOBS}"} modules
}

do_install(){
  cd "${SRCTOP}"

  mkdir -p "${DESTDIR}/boot" "${DESTDIR}/lib/modules"

  make O="${BUILD_DIR}" \
    INSTALL_MOD_PATH="${DESTDIR}" \
    modules_install

  install -m 0644 "${BUILD_DIR}/arch/x86/boot/bzImage" "${DESTDIR}/boot/vmlinuz-${PKG_VER}"
  install -m 0644 "${BUILD_DIR}/System.map"           "${DESTDIR}/boot/System.map-${PKG_VER}"
  install -m 0644 "${BUILD_DIR}/.config"              "${DESTDIR}/boot/config-${PKG_VER}"

  ln -sf "vmlinuz-${PKG_VER}"    "${DESTDIR}/boot/vmlinuz"    2>/dev/null || true
  ln -sf "System.map-${PKG_VER}" "${DESTDIR}/boot/System.map" 2>/dev/null || true
  ln -sf "config-${PKG_VER}"     "${DESTDIR}/boot/config"     2>/dev/null || true

  # Remove symlinks build/source nos modules para reduzir referências ao build dir
  find "${DESTDIR}/lib/modules" -maxdepth 3 -type l \( -name build -o -name source \) -delete 2>/dev/null || true
}
