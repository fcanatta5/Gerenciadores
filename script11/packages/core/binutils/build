#!/usr/bin/env bash
# /var/lib/adm/packages/core/binutils/build
# Binutils final (ld/as/objdump/strip etc) para o sistema musl.
# Build out-of-tree, instala em /usr.
#
# Observações importantes:
# - Para evitar “sujar” o host, o adm instala em DESTDIR.
# - Se você estiver ainda no estágio pós-bootstrap usando /mnt/adm/tools,
#   exporte PATH apontando para a toolchain temporária antes de rodar adm:
#     export PATH=/mnt/adm/tools/bin:$PATH

set -Eeuo pipefail

PKG_NAME="binutils"
PKG_CAT="core"
PKG_VER="2.45.1"
PKG_DESC="GNU Binutils (assembler, linker, and related tools)"
PKG_URL="https://www.gnu.org/software/binutils/"
PKG_LICENSE="GPL-3.0-or-later"

# musl + toolchain base antes do binutils final é o caminho normal
PKG_DEPS=( "core/musl" )
PKG_BDEPS=()

SOURCES=(
  "https://ftp.gnu.org/gnu/binutils/binutils-${PKG_VER}.tar.xz"
)

# IMPORTANTE:
# Seu adm exige checksum para fontes não-git, a menos que ALLOW_NO_CHECKSUM=1.
# Recomendo fortemente trocar por SHA256 real assim que você puder.
ALLOW_NO_CHECKSUM=1
SHA256SUMS=(
  # "<sha256-real-do-binutils-${PKG_VER}.tar.xz>"
)

do_configure(){
  if [[ -r "/var/lib/adm/lib/adm-build-helpers.sh" ]]; then
    # shellcheck disable=SC1091
    source "/var/lib/adm/lib/adm-build-helpers.sh"
    adm_src_enter
    adm_clean_builddir
  else
    mkdir -p "${WORKDIR}/build"
    cd "${WORKDIR}/build"
  fi

  # Configuração “segura e comum” para binutils final:
  # - --prefix=/usr
  # - --disable-werror: evita falha por warnings tratados como erro
  # - --enable-gold=no e --enable-ld=default: ld.bfd padrão (mais compatível)
  # - --enable-plugins: LTO plugins e integração melhor com gcc
  # - --with-system-zlib: usa zlib do sistema (melhor do que embedded)
  #
  # Observação: para sistemas *muito* mínimos, você pode remover --with-system-zlib
  # e construir zlib antes. Aqui assumimos zlib já existe OU você aceitará o fallback.
  #
  # Se não tiver zlib ainda, comente --with-system-zlib e adicione core/zlib no world antes.
  local with_zlib=()
  if pkg-config --exists zlib 2>/dev/null || [[ -f "/usr/include/zlib.h" || -f "${SYSROOT:-}/usr/include/zlib.h" ]]; then
    with_zlib+=(--with-system-zlib)
  else
    # fallback: deixa binutils usar a zlib interna se disponível
    with_zlib+=(--without-system-zlib)
  fi

  ( cd "${WORKDIR}/build" && "${SRCTOP}/configure" \
      --prefix=/usr \
      --disable-nls \
      --disable-werror \
      --enable-plugins \
      --enable-shared \
      --enable-ld=default \
      --enable-gold=no \
      "${with_zlib[@]}" )
}

do_build(){
  make -C "${WORKDIR}/build" ${MAKEFLAGS}
}

do_install(){
  make -C "${WORKDIR}/build" DESTDIR="${DESTDIR}" install

  # Segurança: evita instalar docs/info muito cedo (opcional, mas reduz tamanho)
  rm -rf "${DESTDIR}/usr/share/info" 2>/dev/null || true
  rm -rf "${DESTDIR}/usr/share/man"  2>/dev/null || true

  # Em alguns setups, binutils instala ferramentas redundantes em /usr/${TARGET}/bin.
  # Aqui não forçamos layout multilib/multitarget: mantemos o padrão /usr/bin.
}
