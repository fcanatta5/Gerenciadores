#!/usr/bin/env bash
# /var/lib/adm/packages/core/binutils/build
# Binutils final (ld/as/objdump/strip etc) para sistema musl.
#
# Correções em relação ao script anterior:
# - Dependência EXPLÍCITA de core/zlib (evita autodetecção frágil).
# - Configure consistente e previsível (sem heurísticas).
# - Build out-of-tree limpo.
#
# Recomendação de uso:
#   adm build core/binutils
#   adm install core/binutils

set -Eeuo pipefail

PKG_NAME="binutils"
PKG_CAT="core"
PKG_VER="2.45.1"
PKG_DESC="GNU Binutils (assembler, linker, and related tools)"
PKG_URL="https://www.gnu.org/software/binutils/"
PKG_LICENSE="GPL-3.0-or-later"

# Base: musl + zlib (para recursos que dependem de compressão) + headers já no sistema
PKG_DEPS=(
  "core/musl"
  "core/zlib"
)
PKG_BDEPS=()

SOURCES=(
  "https://ftp.gnu.org/gnu/binutils/binutils-${PKG_VER}.tar.xz"
)

# IMPORTANTE:
# Seu adm exige checksum para fontes não-git, a menos que ALLOW_NO_CHECKSUM=1.
# Recomendo fortemente trocar por SHA256 real assim que possível.
ALLOW_NO_CHECKSUM=1
SHA256SUMS=(
  # "<sha256-real-do-binutils-${PKG_VER}.tar.xz>"
)

do_configure(){
  # Helpers (opcional)
  if [[ -r "/var/lib/adm/lib/adm-build-helpers.sh" ]]; then
    # shellcheck disable=SC1091
    source "/var/lib/adm/lib/adm-build-helpers.sh"
    adm_src_enter
    adm_clean_builddir
  else
    mkdir -p "${WORKDIR}/build"
    export BUILD_DIR="${WORKDIR}/build"
  fi

  # Para builds iniciais em chroot, você pode ainda estar usando toolchain temporária:
  # export PATH=/mnt/adm/tools/bin:$PATH
  # Aqui não forçamos, apenas respeitamos o ambiente.

  # Configuração padrão robusta:
  # --prefix=/usr              -> layout do sistema
  # --disable-nls              -> reduz deps
  # --disable-werror           -> evita falhas por warnings
  # --enable-plugins           -> LTO plugins / integração melhor com gcc
  # --with-system-zlib         -> usa zlib do sistema (dep já declarada)
  # --enable-shared            -> libs compartilhadas
  # --enable-gold=no           -> mantém ld.bfd como padrão (menos surpresas)
  # --enable-ld=default        -> ld.bfd padrão
  #
  ( cd "${BUILD_DIR}" && "${SRCTOP}/configure" \
      --prefix=/usr \
      --disable-nls \
      --disable-werror \
      --enable-plugins \
      --enable-shared \
      --with-system-zlib \
      --enable-gold=no \
      --enable-ld=default )
}

do_build(){
  make -C "${BUILD_DIR:-${WORKDIR}/build}" ${MAKEFLAGS}
}

do_install(){
  make -C "${BUILD_DIR:-${WORKDIR}/build}" DESTDIR="${DESTDIR}" install

  # Sistema base: reduzir tamanho (opcional)
  rm -rf "${DESTDIR}/usr/share/info" 2>/dev/null || true
  rm -rf "${DESTDIR}/usr/share/man"  2>/dev/null || true

  # Garantias mínimas
  mkdir -p "${DESTDIR}/usr/bin" "${DESTDIR}/usr/lib"
}
