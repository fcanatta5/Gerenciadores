# Para instalar o linux-headers
ADM_PROFILE=glibc   \   # ou musl, o pacote de headers é agnóstico
ADM_TARGET_ARCH=x86_64 \
./adm.sh build toolchain/linux-headers

# Criar musl
# 1) Criar diretório do pacote
mkdir -p "${ADM_PACKAGES_DIR}/toolchain/musl"

# 2) Criar arquivos
#   - musl.sh
#   - musl.pre_install
#   - musl.post_install
# (colando exatamente os conteúdos acima)

# 3) Tornar hooks executáveis
chmod +x "${ADM_PACKAGES_DIR}/toolchain/musl/musl.pre_install"
chmod +x "${ADM_PACKAGES_DIR}/toolchain/musl/musl.post_install"

# 4) Construir para o perfil musl
ADM_PROFILE=musl ADM_TARGET_ARCH=x86_64 \
  ./adm.sh build toolchain/musl



Formas de selecionar o profile musl

Você tem duas maneiras equivalentes:

a) Via variável de ambiente

sudo ADM_PROFILE=musl /opt/adm/adm build core/gzip

ou, se você chamou sem categoria:

sudo ADM_PROFILE=musl /opt/adm/adm build gzip

b) Via opção de linha de comando (-P / --profile)

sudo /opt/adm/adm -P musl build core/gzip
# ou
sudo /opt/adm/adm -P musl build gzip

Internamente, isso faz:

ADM_PROFILE=musl

ADM_TARGET_LIBC=musl

TARGET_TRIPLET padrão para x86_64 → x86_64-linux-musl

CC, CXX, AR, RANLIB, LD, AS, STRIP apontando para ${ADM_TOOLCHAIN_PREFIX}/bin/${TARGET_TRIPLET}-*
(ADM_TOOLCHAIN_PREFIX padrão: /opt/cross/x86_64-linux-musl)


Então, para funcionar de verdade com musl, você precisa:

Ter o toolchain x86_64-linux-musl-* instalado em /opt/cross/x86_64-linux-musl/bin
ou

Forçar uso do toolchain nativo com:


sudo ADM_PROFILE=musl ADM_USE_NATIVE=1 /opt/adm/adm build core/gzip

Nesse caso ele usa gcc, g++ nativos, mas ainda aplica as flags específicas do profile musl (-O2 -fstack-protector-strong, etc.).


---

2. Exemplo completo de instalação com musl

Supondo que você já tenha uma receita toolchain/binutils/binutils.sh:

sudo /opt/adm/adm -P musl build toolchain/binutils

ou com env:

sudo ADM_PROFILE=musl /opt/adm/adm build toolchain/binutils

O fluxo será:

1. Carrega a receita do pacote (binutils.sh).


2. Chama setup_profiles com ADM_PROFILE=musl.


3. Baixa o source, verifica checksum (se definido).


4. Configura com ./configure + ADM_CONFIGURE_ARGS_COMMON + PKG_CONFIGURE_OPTS.


5. make + make DESTDIR=... install.


6. strip dos binários.


7. Gera tar.zst.


8. Copia para ${ADM_ROOTFS}.


9. Registra no DB (/opt/adm/db/toolchain/binutils).




---

3. Testar em modo simulação (dry-run)

Antes de rodar pra valer, é útil testar:

sudo /opt/adm/adm -P musl -n build core/gzip
# ou
sudo ADM_PROFILE=musl ADM_DRY_RUN=1 /opt/adm/adm build core/gzip

Ele vai mostrar todos os comandos que seriam executados, sem tocar no sistema.
